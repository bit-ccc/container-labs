#cloud-config
# Cloud-init configuration to install Docker on Ubuntu
# Following the official Docker documentation:
# https://docs.docker.com/engine/install/ubuntu/
#
# Usage:
#   - Paste this into your cloud provider's "user data" field when creating a VM
#   - Or use with: cloud-init init --file cloud-config-ubuntu.yaml
#
# After the instance boots, Docker will be installed and ready to use.

package_update: true
package_upgrade: true

# Remove conflicting packages that might be pre-installed
runcmd:
  # Remove old or conflicting packages
  - for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do apt-get remove -y $pkg || true; done

  # Install required dependencies
  - apt-get install -y ca-certificates curl

  # Create directory for apt keyrings
  - install -m 0755 -d /etc/apt/keyrings

  # Download Docker's official GPG key
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc

  # Add Docker repository to apt sources
  - |
    tee /etc/apt/sources.list.d/docker.sources <<EOF
    Types: deb
    URIs: https://download.docker.com/linux/ubuntu
    Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
    Components: stable
    Signed-By: /etc/apt/keyrings/docker.asc
    EOF

  # Update package index with new repository
  - apt-get update

  # Install Docker packages
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Enable and start Docker service
  - systemctl enable docker
  - systemctl start docker
